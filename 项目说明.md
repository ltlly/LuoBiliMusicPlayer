# B站音乐播放器 - 项目说明

## 项目概述

这是一个完整实现的Android音乐播放器应用，可以与哔哩哔哩账号集成，从收藏夹同步和播放音乐。

**创建的文件总数**: 38个文件
- Kotlin源代码: 30个文件 (~3,800行代码)
- 配置文件: 5个
- 资源文件: 2个
- 文档: 3个

## 已实现的功能

### ✅ 1. 哔哩哔哩登录
- 二维码扫码登录
- 每4秒自动轮询登录状态
- Cookie持久化存储
- Token自动刷新

### ✅ 2. 收藏夹管理
- 获取用户收藏夹列表
- 查看收藏夹内容
- 获取视频详情和播放链接
- WBI签名验证

### ✅ 3. 音乐播放
- Media3 ExoPlayer播放引擎
- 后台播放服务
- 通知栏媒体控制
- **自动支持三星手表控制**（无需额外代码）

### ✅ 4. 下载管理
- 后台下载音频
- 下载进度跟踪
- 音频格式转换（预留FFmpeg接口）
- 下载队列管理

### ✅ 5. 本地数据库
- Room数据库存储歌曲
- 播放列表管理
- 下载记录追踪
- 播放历史记录

### ✅ 6. 用户界面
- Material 3设计
- 深色/浅色主题
- 响应式布局
- 流畅的导航

## 技术架构

```
MVVM架构
├── UI层 (Jetpack Compose)
├── ViewModel层 (待扩展)
├── Repository层
├── 数据源
│   ├── 网络API (Retrofit)
│   └── 本地数据库 (Room)
└── 服务
    ├── 播放服务 (Media3)
    └── 下载服务 (WorkManager)
```

## 核心技术

| 技术 | 用途 |
|------|------|
| Kotlin | 编程语言 |
| Jetpack Compose | UI框架 |
| Material 3 | 设计系统 |
| Media3 | 音乐播放 |
| Retrofit | 网络请求 |
| Room | 本地数据库 |
| WorkManager | 后台下载 |
| Coroutines + Flow | 异步处理 |

## 关键算法实现

### MD5签名算法（用于登录）
```kotlin
签名 = MD5(排序后的参数 + AppSecret)
```

### WBI签名算法（用于API请求）
```kotlin
1. 从nav API获取img_key和sub_key
2. 按mixinKeyEncTab重新排列生成mixin_key
3. 添加wts时间戳到参数
4. 计算: w_rid = MD5(排序参数 + mixin_key)
```

## 项目结构

```
BiliMusicPlayer/
├── app/
│   ├── src/main/
│   │   ├── java/com/bilimusicplayer/
│   │   │   ├── MainActivity.kt              # 主界面
│   │   │   ├── ui/screens/                  # 各个界面
│   │   │   │   ├── LoginScreen.kt          # 登录界面
│   │   │   │   ├── HomeScreen.kt           # 首页
│   │   │   │   ├── FavoriteListScreen.kt   # 收藏夹列表
│   │   │   │   ├── LibraryScreen.kt        # 音乐库
│   │   │   │   ├── SettingsScreen.kt       # 设置
│   │   │   │   └── PlayerScreen.kt         # 播放器
│   │   │   ├── network/bilibili/
│   │   │   │   ├── auth/                   # 登录模块
│   │   │   │   └── favorite/               # 收藏夹模块
│   │   │   ├── data/local/                 # 数据库
│   │   │   ├── service/                    # 服务
│   │   │   └── utils/                      # 工具类
│   │   └── res/                            # 资源文件
│   └── build.gradle.kts                     # 依赖配置
├── README.md                                # 项目文档
└── 项目说明.md                              # 本文件
```

## 如何使用

### 1. 打开项目
```bash
cd /Users/ltlly/Code/BiliMusicPlayer
# 用Android Studio打开此目录
```

### 2. 同步依赖
- 打开Android Studio
- 等待Gradle自动同步
- 如果失败，点击 "Sync Project with Gradle Files"

### 3. 运行应用
- 连接Android设备或启动模拟器
- 点击运行按钮（绿色三角形）
- 最低系统要求：Android 8.0 (API 26)

### 4. 使用流程
1. 启动应用 → 显示二维码
2. 用哔哩哔哩App扫码登录
3. 登录成功后进入首页
4. 点击"浏览收藏夹"查看B站收藏
5. 下载歌曲到本地音乐库
6. 播放音乐

## 最新更新（2026-02-06）

### ✅ 已修复
1. **✅ 用户ID获取** - 从登录API自动获取并保存用户ID
2. **✅ 收藏夹加载** - 登录后可以正常浏览收藏夹
3. **✅ 文档整合** - 删除重复文档，保留统一的中文文档

## 待完善功能

### 必须实现（才能正常使用）
1. **FFmpeg音频转换** - 目前只是占位代码
2. **ID3标签嵌入** - 添加歌曲元数据
3. **ViewModel层** - 为每个界面添加ViewModel
4. **收藏夹内容查看** - 实现查看收藏夹内容和下载功能

### 可选增强
1. 搜索功能
2. 歌词显示
3. 均衡器
4. 离线模式
5. 播放列表同步

## 手表控制说明

应用已自动支持三星手表和其他Wear OS设备的媒体控制。

**工作原理**：
- 使用MediaSessionService
- 系统自动将媒体控制发送到手表
- 无需额外代码
- 支持播放、暂停、上一首、下一首

**测试方法**：
1. 在手机上播放音乐
2. 查看通知栏的媒体控制
3. 如果配对了手表，控制会自动出现在手表上

## 重要提示

### AppKey配置
- AppKey: `4409e2ce8ffd12b8`
- AppSecret: `59b43e04ad6965f34319062b478f83dd`
- 这是哔哩哔哩TV端的公开密钥

### API说明
- 使用的是哔哩哔哩非官方API
- 仅供学习和个人使用
- 请遵守哔哩哔哩服务条款

### 注意事项
1. 首次运行需要网络连接
2. 下载功能需要存储权限
3. 后台播放需要通知权限
4. Cookie存储在本地SharedPreferences

## 文件说明

### 核心文件路径
```
认证模块:
- network/bilibili/auth/BiliAuthApi.kt
- network/bilibili/auth/QRCodeLoginManager.kt

收藏夹模块:
- network/bilibili/favorite/BiliFavoriteApi.kt
- network/bilibili/favorite/WbiSignature.kt

播放服务:
- service/MusicPlaybackService.kt
- service/MusicPlayerController.kt

数据库:
- data/local/AppDatabase.kt
- data/model/Song.kt

界面:
- ui/screens/LoginScreen.kt
- ui/screens/HomeScreen.kt
```

## 开发建议

### 下一步开发
1. 先实现FFmpeg转换功能
2. 添加ViewModel管理状态
3. 完善错误处理
4. 添加单元测试
5. 优化用户体验

### 代码风格
- 遵循Kotlin官方代码规范
- 使用协程处理异步操作
- Flow用于响应式数据流
- Compose用于声明式UI

## 性能优化

已实现的优化：
- ✅ Room数据库索引查询
- ✅ Coil图片加载缓存
- ✅ OkHttp连接池
- ✅ WorkManager智能下载
- ✅ ExoPlayer内存管理

## 常见问题

**Q: 登录二维码不显示？**
A: 检查网络连接，确保能访问bilibili.com

**Q: 收藏夹加载失败？**
A: 需要先完成登录，并且账号有收藏夹

**Q: 下载的音频无法播放？**
A: 目前FFmpeg转换是占位代码，需要实现实际转换逻辑

**Q: 手表上看不到控制？**
A: 确保手表已配对，并且手机正在播放音乐

## 技术支持

- API文档: https://github.com/SocialSisterYi/bilibili-API-collect
- Android开发: https://developer.android.com
- Jetpack Compose: https://developer.android.com/jetpack/compose

## 版本信息

- 版本: 1.0.0
- 最低Android版本: 8.0 (API 26)
- 目标Android版本: 14 (API 34)
- Kotlin版本: 1.9.20
- Compose版本: 1.5.4

## 许可与致谢

本项目基于以下开源项目：
- [azusa-player-mobile](https://github.com/lovegaoshi/azusa-player-mobile) - 参考架构
- [bilibili-API-collect](https://github.com/SocialSisterYi/bilibili-API-collect) - API文档

**免责声明**: 本项目仅用于学习和研究目的，不得用于商业用途。
