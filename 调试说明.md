# 播放列表加载调试说明

## 问题描述
播放几首歌后无法继续播放下一首，通知栏也没有显示播放列表。

## 已添加的调试日志

代码中已经添加了详细的日志输出，标签为 `FavoriteContent`。

### 查看日志的方法

#### 方法1: 使用 Android Studio
1. 连接手机或启动模拟器
2. 在 Android Studio 底部点击 "Logcat"
3. 在过滤器中输入: `FavoriteContent`
4. 播放歌曲，观察日志输出

#### 方法2: 使用 adb 命令
```bash
# 清除旧日志
adb logcat -c

# 实时查看日志
adb logcat | grep FavoriteContent
```

## 关键日志信息

### 1. 初始加载
```
初始播放列表加载完成，共 X 首
开始后台加载，从索引 Y 到 Z
```

### 2. 后台加载过程
```
正在加载第 N 首: [歌曲名称]
成功加载第 N 首，当前队列总数: X
```

### 3. 加载完成
```
后台加载完成，总共加载了 X 首歌曲
```

### 4. 错误信息
```
无法获取音频URL: [歌曲名称]
获取播放地址失败: [歌曲名称]
无法获取CID: [歌曲名称]
获取视频详情失败: [歌曲名称]
加载失败: [歌曲名称], 错误: [错误信息]
```

## 测试步骤

1. **清除日志并启动应用**
   ```bash
   adb logcat -c
   adb logcat | grep -E "FavoriteContent|ExoPlayer|MediaSession"
   ```

2. **播放歌曲**
   - 进入收藏夹
   - 点击任意歌曲播放
   - 观察日志输出

3. **检查初始加载**
   - 应该看到 "初始播放列表加载完成，共 5 首"
   - 应该看到 "开始后台加载" 的消息

4. **等待后台加载**
   - 观察是否有 "正在加载第 X 首" 的日志
   - 观察是否有 "成功加载" 的日志
   - 如果有错误，记录错误信息

5. **测试切歌**
   - 连续点击 "下一曲" 按钮
   - 观察能切换到第几首
   - 记录停止的位置

## 可能的问题和解决方案

### 问题1: 没有看到后台加载日志
**原因**: 后台协程可能被取消
**解决**: 已使用 `GlobalScope` 确保协程不被取消

### 问题2: 看到加载日志但没有成功加载
**原因**:
- 网络请求失败
- API返回错误
- 音频URL获取失败

**排查**:
- 检查错误日志
- 确认网络连接正常
- 检查B站API是否正常

### 问题3: 成功加载但播放器没有响应
**原因**:
- `addMediaItem()` 调用失败
- MediaController 连接断开

**排查**:
- 查看 ExoPlayer 相关日志
- 检查 MediaSession 状态

## 收集信息

如果问题仍然存在，请提供以下信息：

1. **完整的日志输出**
   ```bash
   adb logcat -d > logcat.txt
   ```

2. **测试环境**
   - Android 版本
   - 设备型号
   - 收藏夹歌曲数量

3. **重现步骤**
   - 从第几首开始播放
   - 能正常切换到第几首
   - 是否有错误提示

4. **观察到的现象**
   - 通知栏显示什么
   - 播放器界面显示什么
   - 点击下一曲有什么反应

## 快速测试脚本

```bash
#!/bin/bash

echo "清除日志..."
adb logcat -c

echo "开始监控日志..."
echo "请在手机上播放歌曲..."
echo ""

adb logcat | grep --line-buffered -E "FavoriteContent|ExoPlayer.*MediaItem|MediaSession.*queue"
```

保存为 `monitor_playback.sh`，然后执行：
```bash
chmod +x monitor_playback.sh
./monitor_playback.sh
```
