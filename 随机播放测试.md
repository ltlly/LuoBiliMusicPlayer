# 随机播放功能测试

## 问题描述
开启随机播放时，有时候要点击两三次"下一首"才能切歌。

## 已实施的改进

### 1. 增强的切歌逻辑
在 `MusicPlayerController.kt` 中改进了 `skipToNext()` 方法：
- 添加了详细的日志输出
- 检查当前索引和总数
- 确保切歌后自动 prepare 和 play
- 处理随机模式和顺序模式

### 2. 随机播放配置
在 `MusicPlaybackService.kt` 中配置了：
- 设置 `DefaultShuffleOrder`
- 配置 `playWhenReady = true`

### 3. 状态同步
- 切换随机模式时强制更新播放状态
- 确保 UI 和播放器状态同步

## 测试步骤

### 基础测试
1. **启动日志监控**
   ```bash
   adb logcat | grep -E "MusicPlayerController|FavoriteContent"
   ```

2. **播放歌曲**
   - 进入收藏夹
   - 点击任意歌曲播放
   - 等待至少加载5首歌曲

3. **测试顺序播放**
   - 确保随机播放关闭（图标为灰色）
   - 连续点击"下一首"5次
   - 观察：
     - 每次点击是否立即切歌
     - 日志中的索引是否按顺序递增（0→1→2→3→4）
     - 是否有延迟或需要多次点击

4. **测试随机播放**
   - 点击随机播放按钮（图标变为蓝色）
   - 观察日志输出 "设置随机播放: true"
   - 连续点击"下一首"10次
   - 观察：
     - 每次点击是否立即切歌
     - 日志中的索引是否随机（如: 0→3→1→4→2）
     - 是否需要多次点击才能切歌

### 详细日志分析

#### 正常的日志输出应该是：
```
MusicPlayerController: 设置随机播放: true
MusicPlayerController: skipToNext - 当前索引: 0, 总数: 5, 随机模式: true
MusicPlayerController: skipToNext - 切换到下一首
MusicPlayerController: skipToNext - 当前索引: 3, 总数: 5, 随机模式: true
MusicPlayerController: skipToNext - 切换到下一首
MusicPlayerController: skipToNext - 当前索引: 1, 总数: 5, 随机模式: true
MusicPlayerController: skipToNext - 切换到下一首
```

#### 异常的日志输出：
```
MusicPlayerController: skipToNext - 当前索引: 0, 总数: 5, 随机模式: true
MusicPlayerController: skipToNext - 切换到下一首
MusicPlayerController: skipToNext - 当前索引: 0, 总数: 5, 随机模式: true  ← 索引没变！
MusicPlayerController: skipToNext - 切换到下一首
```

### 压力测试
1. **快速连续点击测试**
   - 开启随机播放
   - 快速连续点击"下一首"按钮20次
   - 观察是否每次都能正常切歌

2. **通知栏测试**
   - 开启随机播放
   - 下拉通知栏
   - 在通知栏中点击"下一首"按钮
   - 测试10次，观察是否正常

3. **迷你播放器测试**
   - 开启随机播放
   - 返回其他页面（显示迷你播放器）
   - 点击迷你播放器的"下一首"按钮
   - 测试是否正常

## 可能的问题和原因

### 问题1: 点击后索引不变
**现象**: 日志显示索引始终不变
**原因**:
- ExoPlayer 的 shuffleModeEnabled 没有正确设置
- MediaController 连接断开

**排查**:
```bash
adb logcat | grep -E "shuffleModeEnabled|ShuffleOrder"
```

### 问题2: 需要多次点击
**现象**: 第一次点击无反应，第二次才切歌
**原因**:
- 播放器状态不是 READY
- 下一首歌曲还未加载完成

**排查**:
```bash
adb logcat | grep -E "playbackState|isPlaying"
```

### 问题3: 随机模式下切歌卡顿
**现象**: 切歌有明显延迟
**原因**:
- 网络加载慢
- 后台加载队列没有足够的歌曲

**解决**: 等待后台加载更多歌曲

## 改进建议

如果问题仍然存在，可以尝试以下方案：

### 方案1: 预加载策略
在切换到下一首之前，预先加载下一首歌曲的音频数据。

### 方案2: 自定义随机算法
不使用 ExoPlayer 的 shuffleModeEnabled，而是自己管理随机播放顺序。

### 方案3: 增加缓冲
在播放列表中始终保持至少10首已加载的歌曲。

## 收集问题信息

如果随机播放仍有问题，请提供：

1. **完整日志**
   ```bash
   adb logcat -d > shuffle_issue.log
   ```

2. **重现步骤**
   - 播放第几首歌曲
   - 点击了几次"下一首"
   - 是否有延迟（几秒）
   - 最终是否切歌成功

3. **播放列表状态**
   - 当前播放第几首
   - 总共加载了几首
   - 随机模式是否开启

4. **测试视频**（如果可能）
   - 录制屏幕操作
   - 展示点击次数和切歌反应
