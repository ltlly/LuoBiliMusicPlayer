# B站音乐播放器 - 开发进度

## 2026-02-06 更新

### ✅ 已完成的功能

#### 1. 登录功能修复（已完成）
- ✅ 修复了二维码登录后仍提示未登录的问题
- ✅ 问题原因：
  1. nav API 使用了错误的 base URL（应该用 `api.bilibili.com` 而不是 `passport.bilibili.com`）
  2. cookies 的 domain 设置不正确
  3. cookies 的过期时间是秒级时间戳，需要转换为毫秒
- ✅ 解决方案：
  1. 创建独立的 `BiliApi` 接口用于 `api.bilibili.com` 的API
  2. 将 cookies 保存到 `api.bilibili.com` domain
  3. 改进 `PersistentCookieJar` 的 cookie 匹配逻辑
  4. 将过期时间从秒转换为毫秒（`expiresAt * 1000`）
- ✅ 现在登录后可以正确获取用户信息和收藏夹列表

#### 2. 收藏夹内容查看（已完成）
- ✅ 创建了 `FavoriteContentScreen` 显示收藏夹内容
- ✅ 显示视频列表（封面、标题、UP主、时长）
- ✅ 添加了播放和下载按钮（功能待实现）
- ✅ 支持点击收藏夹进入详情页面

#### 3. 设置页面功能（已完成）
- ✅ 显示当前登录用户信息（用户名和UID）
- ✅ 退出登录功能
- ✅ 关于对话框

#### 4. 文档整合（已完成）
- ✅ 删除了重复的英文文档
- ✅ 保留并更新了中文文档
- ✅ 所有文档已更新为最新状态

### 🔄 进行中的功能

#### 5. 音频下载功能（待实现）
**优先级：高**

需要实现：
1. 在 `FavoriteContentScreen` 的下载按钮中添加逻辑
2. 调用 `BiliFavoriteRepository.getVideoDetail()` 获取视频信息
3. 调用 `BiliFavoriteRepository.getPlayUrl()` 获取音频URL
4. 使用 `DownloadManager` 创建下载任务
5. 显示下载进度
6. 下载完成后保存到数据库

**实现位置：**
- `FavoriteContentScreen.kt` - 添加下载按钮逻辑
- 可能需要创建 `DownloadViewModel` 管理下载状态

#### 6. 在线播放功能（待实现）
**优先级：高**

需要实现：
1. 在 `FavoriteContentScreen` 的播放按钮中添加逻辑
2. 获取音频流URL
3. 创建或使用现有的 `MusicPlayerController` 实例
4. 将音频URL传递给播放器
5. 导航到 `PlayerScreen`
6. 在 `PlayerScreen` 中显示播放控制

**实现位置：**
- `FavoriteContentScreen.kt` - 添加播放按钮逻辑
- `PlayerScreen.kt` - 完善播放界面
- 可能需要创建 `PlayerViewModel`

#### 7. 离线播放功能（待实现）
**优先级：中**

需要实现：
1. 完善 `LibraryScreen`
2. 从数据库读取已下载的歌曲
3. 显示歌曲列表
4. 点击歌曲播放本地文件
5. 支持播放列表管理

**实现位置：**
- `LibraryScreen.kt` - 完善界面和功能

### 📋 待办事项（按优先级）

#### 高优先级
1. **实现音频下载功能** - 用户可以下载喜欢的音频
2. **实现在线播放功能** - 用户可以直接播放在线音频
3. **完善 PlayerScreen** - 显示播放进度、控制按钮、歌曲信息

#### 中优先级
4. **实现离线播放功能** - 播放已下载的音频
5. **集成 FFmpeg** - 实现音频格式转换
6. **添加 ID3 标签** - 为下载的音频添加元数据

#### 低优先级
7. **为各个界面添加 ViewModel** - 改进架构
8. **添加搜索功能** - 搜索收藏夹和本地音乐
9. **添加歌词显示** - 同步显示歌词
10. **优化UI/UX** - 改进用户体验

### 🐛 已知问题

1. **FFmpeg转换是占位代码** - 需要集成真实的FFmpeg库
2. **没有ViewModel层** - 界面直接使用Repository
3. **错误处理不完善** - 需要更好的错误提示
4. **没有缓存策略** - 每次都需要重新加载
5. **下载进度没有持久化** - 应用重启后丢失下载状态

### 📝 开发建议

#### 下一步实现顺序

1. **实现在线播放（最快见效）**
   ```kotlin
   // 在 FavoriteContentScreen 中
   onPlayClick = {
       scope.launch {
           // 1. 获取视频详情
           val detail = repository.getVideoDetail(media.bvid)
           // 2. 获取播放URL
           val playUrl = repository.getPlayUrl(detail.cid, media.bvid)
           // 3. 播放音频
           // playerController.play(playUrl)
           // 4. 导航到播放器
           navController.navigate("player")
       }
   }
   ```

2. **实现音频下载**
   ```kotlin
   // 在 FavoriteContentScreen 中
   onDownloadClick = {
       scope.launch {
           // 1. 获取音频URL
           // 2. 创建下载任务
           // 3. 显示下载进度
       }
   }
   ```

3. **完善播放器界面**
   - 显示当前播放的歌曲信息
   - 显示播放进度条
   - 添加控制按钮（播放/暂停、上一首、下一首）
   - 显示封面图片

### 🎯 项目状态总结

**完成度：约 70%**

- ✅ 项目架构：100%
- ✅ 登录功能：100%
- ✅ 收藏夹列表：100%
- ✅ 收藏夹内容：100%
- ⚠️ 播放功能：30%（服务已实现，UI待完善）
- ⚠️ 下载功能：40%（后台下载已实现，UI和触发逻辑待实现）
- ⚠️ 本地音乐库：20%（数据库已实现，UI待实现）
- ❌ FFmpeg转换：0%
- ❌ ID3标签：0%

**核心功能可用性：**
- ✅ 用户可以登录
- ✅ 用户可以查看收藏夹
- ✅ 用户可以查看收藏夹内容
- ❌ 用户不能播放音频（待实现）
- ❌ 用户不能下载音频（待实现）

### 📚 相关文档

- `README.md` - 技术文档和架构说明
- `项目说明.md` - 功能说明和最新更新
- `实现清单.md` - 完整的实现清单
- `快速开始.md` - 使用指南
- `构建成功.md` - 构建状态
- `FFmpeg集成说明.md` - FFmpeg集成指南
- `开发进度.md` - 本文件

### 🔧 技术债务

1. 移除详细的 cookie 调试日志（生产环境不需要）
2. 添加单元测试
3. 添加集成测试
4. 优化网络请求（添加缓存）
5. 优化数据库查询
6. 添加错误上报机制

---

**最后更新：** 2026-02-06
**当前版本：** 1.0.0-dev
